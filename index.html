<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patel Diagnostic - Separated Entry System</title>
    <style>
        @page { size: A5; margin: 5mm; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; }
        .invoice-card { width: 148mm; min-height: 210mm; background: white; margin: 10px auto; padding: 15px; box-sizing: border-box; border: 1px solid #ccc; position: relative; }
        
        .header { text-align: center; border-bottom: 2px solid #b71c1c; margin-bottom: 10px; }
        .header h1 { margin: 0; font-size: 20px; color: #b71c1c; }
        .meta-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .patient-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; margin-bottom: 15px; }
        .patient-grid div { display: flex; border-bottom: 1px solid #ddd; }
        .patient-grid label { font-weight: bold; width: 80px; color: #555; }
        .patient-grid input { border: none; outline: none; width: 100%; padding: 2px; font-size: 12px; }

        /* SEPARATE SECTIONS */
        .entry-box { background: #fff; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .section-title { font-size: 11px; font-weight: bold; color: #2e7d32; text-transform: uppercase; margin-bottom: 5px; display: block; }
        
        /* Search Style */
        .search-wrap { position: relative; }
        .search-input { width: 100%; padding: 8px; border: 1px solid #4CAF50; border-radius: 4px; box-sizing: border-box; }
        #dropdown { position: absolute; width: 100%; background: white; border: 1px solid #ccc; z-index: 100; max-height: 150px; overflow-y: auto; display: none; }
        .drop-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 12px; }
        .drop-item:hover { background: #f1f1f1; }

        /* Manual Style */
        .manual-flex { display: flex; gap: 5px; }
        .manual-name { flex: 2; padding: 8px; border: 1px solid #007bff; border-radius: 4px; }
        .manual-price { width: 70px; padding: 8px; border: 1px solid #007bff; border-radius: 4px; }
        .btn-add { background: #007bff; color: white; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* Table */
        .invoice-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .invoice-table th { background: #4CAF50; color: white; padding: 8px; text-align: left; }
        .invoice-table td { padding: 8px; border-bottom: 1px solid #ddd; }
        
        .total-section { border-top: 2px solid #4CAF50; margin-top: 10px; text-align: right; }
        .total-row { display: flex; justify-content: flex-end; align-items: center; margin-top: 5px; font-weight: bold; }
        .disc-in { width: 70px; text-align: right; margin-left: 10px; border: 1px solid #ccc; padding: 4px; }

        .no-print { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .btn-action { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-save { background: #2e7d32; }
        .btn-wa { background: #25d366; }

        .history-box { margin-top: 15px; border-top: 2px dashed #007bff; padding-top: 10px; }
        .hist-in { width: 100%; padding: 8px; border: 1px solid #007bff; border-radius: 4px; margin-bottom: 5px; font-size: 12px; }
        #histList { max-height: 80px; overflow-y: auto; background: white; font-size: 11px; }
        .hist-item { padding: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }

        @media print {
            .no-print, .entry-box, .history-box, .btn-del { display: none !important; }
            .disc-in { border: none !important; }
            body { background: white; }
            .invoice-card { border: none; box-shadow: none; width: 100%; margin: 0; }
        }
    </style>
</head>
<body onload="init()">

<div class="invoice-card" id="billArea">
    <div class="header">
        <h1>PATEL DIAGNOSTIC UDAIPUR</h1>
        <p>Titaradi, Udaipur | 8209746239</p>
    </div>

    <div class="meta-row">
        <div>Inv No: <b id="invNum">20260001</b></div>
        <div id="clock"></div>
    </div>

    <div class="patient-grid">
        <div><label>Name:</label><input type="text" id="pName"></div>
        <div><label>Age/Sex:</label><input type="text" id="pAge"></div>
        <div><label>Mobile:</label><input type="text" id="pMob"></div>
        <div><label>Ref. By:</label><input type="text" id="pRef" value="Self"></div>
    </div>

    <div class="entry-box no-print" style="border-color: #4CAF50;">
        <span class="section-title">üîç Search From Google Sheet</span>
        <div class="search-wrap">
            <input type="text" id="searchIn" class="search-input" placeholder="Type test name (e.g. CBC, Liver)..." onkeyup="searchSheet()">
            <div id="dropdown"></div>
        </div>
        <div id="loadStatus" style="font-size: 9px; color: #666; margin-top: 4px;">Loading tests...</div>
    </div>

    <div class="entry-box no-print" style="border-color: #007bff;">
        <span class="section-title">‚úçÔ∏è Manual Test Entry</span>
        <div class="manual-flex">
            <input type="text" id="manName" class="manual-name" placeholder="Test Name">
            <input type="number" id="manPrice" class="manual-price" placeholder="Price">
            <button class="btn-add" onclick="addManual()">ADD</button>
        </div>
    </div>

    <table class="invoice-table">
        <thead>
            <tr><th>Description</th><th style="text-align:right">Amount (‚Çπ)</th><th class="no-print"></th></tr>
        </thead>
        <tbody id="billBody"></tbody>
    </table>

    <div class="total-section">
        <div class="total-row">Sub Total: ‚Çπ<span id="subT">0</span></div>
        <div class="total-row">Discount (‚Çπ): <input type="number" id="disc" class="disc-in" value="0" oninput="calc()"></div>
        <div class="total-row" style="color: #b71c1c; font-size: 16px;">Net Total: ‚Çπ<span id="netT">0</span></div>
    </div>

    <div class="no-print">
        <button class="btn-action btn-save" onclick="saveBill()">PRINT & SAVE</button>
        <button class="btn-action btn-wa" onclick="shareWA()">SEND WHATSAPP</button>
    </div>

    <div class="history-box no-print">
        <span class="section-title" style="color: #007bff;">üìú Old Bill History</span>
        <input type="text" class="hist-in" id="histIn" placeholder="Search by name or mobile..." onkeyup="searchHistory()">
        <div id="histList"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    let sheetData = [];
    let currentItems = [];
    let invId = localStorage.getItem('p_inv_id') || 20260001;
    let localHistory = JSON.parse(localStorage.getItem('p_history')) || [];

    async function init() {
        document.getElementById('invNum').innerText = invId;
        // Using your requested Google Sheet link
        const sheetId = '1_IFDJ3C5tyGHSY-pR4LSqq-mIT8Rgpx6EDDfh17zzvo';
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

        try {
            const res = await fetch(url);
            const csv = await res.text();
            const rows = csv.split('\n').slice(1);
            sheetData = rows.map(r => {
                const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return { n: c[1]?.replace(/"/g,'').trim(), p: parseInt(c[2]?.replace(/"/g,'')) || 0 };
            }).filter(x => x.n);
            document.getElementById('loadStatus').innerText = `‚úÖ ${sheetData.length} Tests Ready`;
        } catch(e) {
            document.getElementById('loadStatus').innerText = "‚ö†Ô∏è Sheet Error. Set sharing to 'Anyone with link'.";
        }
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleString(); }, 1000);
    }

    // SECTION 1: SEARCH LOGIC
    function searchSheet() {
        const q = document.getElementById('searchIn').value.toLowerCase();
        const d = document.getElementById('dropdown');
        d.innerHTML = '';
        if(!q) { d.style.display = 'none'; return; }
        
        const matches = sheetData.filter(x => x.n.toLowerCase().includes(q));
        matches.slice(0, 10).forEach(m => {
            const div = document.createElement('div');
            div.className = 'drop-item';
            div.innerHTML = `<span>${m.n}</span> <b>‚Çπ${m.p}</b>`;
            div.onclick = () => { addItem(m.n, m.p); d.style.display='none'; document.getElementById('searchIn').value=''; };
            d.appendChild(div);
        });
        d.style.display = matches.length ? 'block' : 'none';
    }

    // SECTION 2: MANUAL LOGIC
    function addManual() {
        const n = document.getElementById('manName').value;
        const p = document.getElementById('manPrice').value;
        if(n && p) {
            addItem(n, parseInt(p));
            document.getElementById('manName').value = '';
            document.getElementById('manPrice').value = '';
        } else {
            alert("Enter both Name and Price");
        }
    }

    function addItem(n, p) {
        currentItems.push({n, p});
        render();
    }

    function render() {
        const b = document.getElementById('billBody');
        b.innerHTML = '';
        let s = 0;
        currentItems.forEach((item, i) => {
            s += item.p;
            b.innerHTML += `<tr><td>${item.n}</td><td style="text-align:right">${item.p}</td><td class="no-print" style="color:red; cursor:pointer" onclick="currentItems.splice(${i},1);render()">‚úñ</td></tr>`;
        });
        document.getElementById('subT').innerText = s;
        calc();
    }

    function calc() {
        const s = parseInt(document.getElementById('subT').innerText);
        const d = parseInt(document.getElementById('disc').value) || 0;
        document.getElementById('netT').innerText = s - d;
    }

    function saveBill() {
        const name = document.getElementById('pName').value;
        if(!name) return alert("Patient Name Required");

        const data = {
            id: invId,
            name: name,
            mob: document.getElementById('pMob').value,
            date: new Date().toLocaleDateString(),
            total: document.getElementById('netT').innerText,
            tests: currentItems.map(x => x.n).join(", ")
        };
        localHistory.push(data);
        localStorage.setItem('p_history', JSON.stringify(localHistory));

        window.print();
        localStorage.setItem('p_inv_id', parseInt(invId) + 1);
        location.reload();
    }

    function shareWA() {
        const name = document.getElementById('pName').value;
        const mob = document.getElementById('pMob').value;
        const total = document.getElementById('netT').innerText;
        
        // Generate PDF
        const element = document.getElementById('billArea');
        html2pdf().from(element).set({ 
            margin: 10, filename: `Bill_${name}.pdf`, jsPDF: { format: 'a5' } 
        }).save();

        const text = `*PATEL DIAGNOSTIC UDAIPUR*%0AInv No: ${invId}%0APatient: ${name}%0ATotal: ‚Çπ${total}%0A_Please download and attach the PDF invoice._`;
        window.open(`https://wa.me/91${mob}?text=${text}`, '_blank');
    }

    function searchHistory() {
        const q = document.getElementById('histIn').value.toLowerCase();
        const l = document.getElementById('histList');
        l.innerHTML = '';
        if(!q) return;
        localHistory.filter(b => b.name.toLowerCase().includes(q) || b.mob.includes(q)).reverse().forEach(b => {
            const div = document.createElement('div');
            div.className = 'hist-item';
            div.innerHTML = `<span>#${b.id} | ${b.name}</span> <b>‚Çπ${b.total}</b>`;
            l.appendChild(div);
        });
    }
</script>
</body>
</html>
