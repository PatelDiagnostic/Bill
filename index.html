<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patel Diagnostic Udaipur - Final</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 10px; background: #f4f4f4; }
        .invoice-box { width: 210mm; height: 148.5mm; background: white; margin: auto; padding: 10mm; box-sizing: border-box; border-bottom: 2px dashed #bbb; position: relative; }
        
        .header { text-align: center; border-bottom: 3px solid #d35400; padding-bottom: 5px; margin-bottom: 12px; }
        .header h1 { margin: 0; color: #d35400; font-size: 24pt; text-transform: uppercase; }
        .header p { margin: 2px 0; font-size: 10pt; font-weight: bold; }

        .customer-info { display: grid; grid-template-columns: 1.5fr 1fr 0.5fr 0.5fr; gap: 8px; margin-bottom: 12px; font-size: 10pt; }
        .info-item { border-bottom: 1px solid #ccc; padding: 5px 0; display: flex; align-items: center; }
        .info-item b { margin-right: 5px; color: #555; }
        .required-field { border-bottom: 2px solid #e74c3c !important; }
        input { border: none; width: 100%; outline: none; font-size: 10pt; background: transparent; }

        .controls { background: #eef2f3; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; gap: 10px; border: 1px solid #ddd; }
        #testSearch { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { padding: 10px 20px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-add { background: #2980b9; color: white; }
        .btn-manual { background: #8e44ad; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 10pt; }
        th { background: #2c3e50; color: white; padding: 8px; text-align: left; }
        td { border: 1px solid #ccc; padding: 8px; }
        .text-right { text-align: right; }

        .summary { float: right; width: 35%; margin-top: 10px; }
        .sum-row { display: flex; justify-content: space-between; padding: 4px 0; }
        .grand-total { font-weight: bold; font-size: 14pt; border-top: 2px solid #d35400; color: #d35400; padding-top: 5px; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .invoice-box { border: none; height: auto; padding: 5mm; }
        }
    </style>
</head>
<body onload="initInvoice()">

<div class="invoice-box">
    <div class="header">
        <h1>PATEL DIAGNOSTIC UDAIPUR</h1>
        <p>Titaradi, Udaipur | Contact: 8209746239</p>
    </div>

    <div class="controls no-print">
        <input type="text" id="testSearch" list="testList" placeholder="Search Test (e.g. CBC, Liver, Fever)">
        <datalist id="testList"></datalist>
        <button type="button" class="btn btn-add" onclick="addTest()">Add</button>
        <button type="button" class="btn btn-manual" onclick="manualAdd()">Manual</button>
    </div>

    <div class="customer-info">
        <div class="info-item" id="nameBox"><b>Name:*</b> <input type="text" id="pName" placeholder="Compulsory"></div>
        <div class="info-item" id="ageBox"><b>Age:*</b> <input type="text" id="pAge" placeholder="Compulsory"></div>
        <div class="info-item" id="sexBox"><b>Sex:*</b> <input type="text" id="pSex" placeholder="M/F"></div>
        
        <div class="info-item"><b>Inv No:</b> <span id="invNo" style="font-weight:bold;"></span></div>
        <div class="info-item"><b>Date/Time:</b> <span id="liveClock" style="font-size: 8pt;"></span></div>
        <div class="info-item" style="grid-column: span 2;"><b>Contact:</b> <input type="text" placeholder="Mobile"></div>
        <div class="info-item" style="grid-column: span 4;"><b>Refer By:</b> <input type="text" placeholder="Doctor Name / Self"></div>
    </div>

    <table>
        <thead>
            <tr>
                <th width="8%">Sr.</th>
                <th width="62%">Test Name</th>
                <th class="text-right" width="20%">Base Rate (₹)</th>
                <th class="no-print" width="10%">Act</th>
            </tr>
        </thead>
        <tbody id="billBody"></tbody>
    </table>

    <div class="summary">
        <div class="sum-row"><span>Sub Total:</span> <span id="subTotal">0.00</span></div>
        <div id="discRow" class="sum-row" style="color:#c0392b;">
            <span>Discount (₹):</span> 
            <input type="number" id="discInput" value="0" oninput="calculateTotal()" class="no-print" style="width: 70px; text-align: right;">
            <span class="print-only" id="discDisplay">0.00</span>
        </div>
        <div class="sum-row grand-total"><span>Total:</span> <span id="grandTotal">0.00</span></div>
    </div>
</div>

<div class="no-print" style="text-align: center; margin-top: 30px;">
    <button onclick="finalPrintCheck()" class="btn" style="background:#27ae60; color:white; font-size:18px; padding:15px 50px;">Print & Save Bill</button>
</div>

<script>
    // BASE RATES EXTRACTED FROM PDF
    const baseRates = {
        "Bharatfit Super Health Package": 1399, "One Plus One BharatFit Package-2": 2249, "One Plus One BharatFit Package-5": 3799, "Health Fit Package-4": 2200, "Semen Analysis": 400, "Dengue & Chikungunya RNA Detection PCR": 1899, "Fever Panel IV": 1499, "Fever Panel III": 1399, "Fever Panel I": 699, "Fatty Liver Screening Package": 1599, "Fever Plus Diagnostic Profile": 3999, "BharatFit Women-Comprehensive": 4499, "BharatFit Women-Advance": 3499, "BharatFit Women-Essential": 2499, "Haemogram (CBC + ESR + PS)": 499, "Sepsis Panel-Basic": 1599, "Fever Insta Check (CBC + CRP)": 549, "Aayush Package-5": 1299, "Aayush Package-1": 499, "BharatFit Super Advance": 3599, "BharatFit Advance": 3149, "Lipase, Fluid": 700, "Amylase, Fluid": 400, "BRCA 1 & 2 Mutation Analysis NGS": 8000, "Dengue IgG & IgM, Rapid": 550, "Dengue NS1, Rapid": 450, "BharatFit Senior Citizen Package- Female": 3149, "BharatFit Senior Citizen Package- Male": 3149, "BharatFit Healthy Heart Package": 2599, "Urine Profile": 899, "Malaria Screening Panel": 799, "Bumper Pocket Saver Package": 199, "Cholesterol Profile": 350, "BharatFit Package 4": 1849, "BharatFit Package-1": 899, "BharatFit Pro": 599, "Ante Natal Profile Basic": 800, "KFT Urine Routine": 500, "Peripheral Blood Smear": 100, "Absolute Basophils Count": 160, "Microalbumin-Creatinine Ratio": 240, "Fever Panel-Comprehensive": 1799, "HIV Early Screen": 700, "Vitamin D Test (25 Hydroxy)": 649, "Urine Routine & Microscopic": 50, "TSH 3rd Generation": 380, "Triglycerides": 180, "Total Protein": 70, "Thyroid Profile Total": 450, "SGPT/ALT": 100, "SGOT/AST": 100, "Liver Function Test (LFT)": 399, "Kidney Function Test (KFT)": 399, "HBA1C Test": 299, "Complete Hemogram (CBC & ESR)": 299, "Complete Blood Count (CBC)": 249, "Blood Group Test": 50, "Vitamin B12 Test": 549
    };

    let items = [];

    function updateClock() {
        const now = new Date();
        document.getElementById('liveClock').innerText = now.toLocaleString('en-IN');
    }

    function initInvoice() {
        setInterval(updateClock, 1000);
        updateClock();
        document.getElementById('invNo').innerText = localStorage.getItem('lastInvPatel') || 20260001;
        
        const dlist = document.getElementById('testList');
        Object.keys(baseRates).sort().forEach(t => {
            let opt = document.createElement('option');
            opt.value = t;
            dlist.appendChild(opt);
        });
    }

    function addTest() {
        const name = document.getElementById('testSearch').value;
        if (baseRates[name]) {
            items.push({ name: name, price: baseRates[name] });
            render();
            document.getElementById('testSearch').value = '';
        } else if (name !== "") {
            alert("Test not in system.");
        }
    }

    function manualAdd() {
        const n = prompt("Test Name:");
        const p = prompt("Base Price:");
        if (n && p) {
            items.push({ name: n, price: parseFloat(p) });
            render();
        }
    }

    function render() {
        const body = document.getElementById('billBody');
        body.innerHTML = '';
        let sub = 0;
        items.forEach((it, i) => {
            sub += it.price;
            body.innerHTML += `<tr><td>${i+1}</td><td>${it.name}</td><td class="text-right">${it.price.toFixed(2)}</td><td class="no-print"><button onclick="items.splice(${i},1);render()">✖</button></td></tr>`;
        });
        document.getElementById('subTotal').innerText = sub.toFixed(2);
        calculateTotal();
    }

    function calculateTotal() {
        const sub = parseFloat(document.getElementById('subTotal').innerText);
        const disc = parseFloat(document.getElementById('discInput').value) || 0;
        document.getElementById('grandTotal').innerText = (sub - disc).toFixed(2);
        document.getElementById('discDisplay').innerText = disc.toFixed(2);
    }

    function finalPrintCheck() {
        const name = document.getElementById('pName').value.trim();
        const age = document.getElementById('pAge').value.trim();
        const sex = document.getElementById('pSex').value.trim();

        // Reset Styles
        document.getElementById('nameBox').classList.remove('required-field');
        document.getElementById('ageBox').classList.remove('required-field');
        document.getElementById('sexBox').classList.remove('required-field');

        if (!name || !age || !sex) {
            alert("Error: Name, Age, and Sex are compulsory fields!");
            if (!name) document.getElementById('nameBox').classList.add('required-field');
            if (!age) document.getElementById('ageBox').classList.add('required-field');
            if (!sex) document.getElementById('sexBox').classList.add('required-field');
            return;
        }

        if (items.length === 0) return alert("Please add a test.");

        // Smart Hide Discount Row
        if (parseFloat(document.getElementById('discInput').value) === 0) {
            document.getElementById('discRow').classList.add('no-print');
        } else {
            document.getElementById('discRow').classList.remove('no-print');
        }

        window.print();
        
        // Auto-increment
        let next = parseInt(document.getElementById('invNo').innerText) + 1;
        localStorage.setItem('lastInvPatel', next);
        setTimeout(() => { location.reload(); }, 1000);
    }
</script>

</body>
</html>
