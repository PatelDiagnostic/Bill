<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patel Diagnostic - Smart Invoice</title>
    <style>
        /* A4 Reset */
        @media print {
            @page { size: A4; margin: 0; }
            body { margin: 0; padding: 0; background: #fff !important; }
            .no-print { display: none !important; }
            .invoice-shell { border: none !important; box-shadow: none !important; width: 100% !important; margin: 0 !important; padding: 10mm !important; }
            /* Only show discount row if it has the 'has-value' class */
            .disc-row:not(.has-value) { display: none !important; }
        }

        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 20px; }
        
        /* Lock Screen */
        #lock { position: fixed; inset: 0; background: #1a1a1a; z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .lock-box { background: white; padding: 30px; border-radius: 8px; text-align: center; border: 2px solid #000; }

        /* Invoice Layout (Upper A4) */
        .invoice-shell { 
            width: 210mm; 
            min-height: 140mm; 
            background: white; 
            margin: auto; 
            padding: 15mm; 
            box-sizing: border-box; 
            border: 1px solid #000;
        }

        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 15px; }
        .header h1 { margin: 0; font-size: 26px; }

        .patient-info { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .patient-info td { padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; }

        .items-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #000; }
        .items-table th { border: 1px solid #000; background: #f2f2f2; padding: 10px; text-align: left; }
        .items-table td { border: 1px solid #000; padding: 10px; font-size: 14px; }

        .summary-box { float: right; width: 250px; margin-top: 20px; border: 1px solid #000; padding: 10px; }
        .sum-line { display: flex; justify-content: space-between; padding: 5px 0; font-weight: bold; }
        
        /* This class is controlled by JavaScript */
        .disc-row { display: flex; justify-content: space-between; padding: 5px 0; font-weight: bold; border-top: 1px solid #eee; }
        .disc-row:not(.has-value) { display: none; }

        .control-panel { width: 210mm; margin: 20px auto; background: #fff; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .search-container { position: relative; margin-bottom: 15px; }
        #dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ccc; z-index: 500; max-height: 200px; overflow-y: auto; display: none; }
        .drop-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; border: none; border-radius: 4px; }
    </style>
</head>
<body>

<div id="lock">
    <div class="lock-box">
        <h2>Patel Diagnostic Admin</h2>
        <input type="password" id="pass" placeholder="Enter Password"><br><br>
        <button onclick="login()" style="background:#000; color:#fff">Enter System</button>
    </div>
</div>

<div class="invoice-shell">
    <div class="header">
        <h1>PATEL DIAGNOSTIC UDAIPUR</h1>
        <p>Titaradi, Udaipur | Contact: 8209746239</p>
    </div>

    <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 10px; font-weight:bold;">
        <span>Invoice No: <span id="dispInv">---</span></span>
        <span id="dispDate"></span>
    </div>

    <table class="patient-info">
        <tr>
            <td><b>Patient:</b> <span id="outName"></span></td>
            <td><b>Age/Sex:</b> <span id="outAge"></span></td>
        </tr>
        <tr>
            <td><b>Mobile:</b> <span id="outMob"></span></td>
            <td><b>Ref. By:</b> <span id="outRef"></span></td>
        </tr>
    </table>

    <table class="items-table">
        <thead>
            <tr>
                <th style="width: 75%;">Test Description</th>
                <th style="width: 25%; text-align: right;">Amount (â‚¹)</th>
            </tr>
        </thead>
        <tbody id="outItems"></tbody>
    </table>

    <div class="summary-box">
        <div class="sum-line"><span>Sub-Total:</span> <span>â‚¹<span id="outSub">0</span></span></div>
        <div id="discRow" class="disc-row">
            <span>Discount:</span> <span>- â‚¹<span id="outDisc">0</span></span>
        </div>
        <div class="sum-line" style="font-size: 18px; border-top: 2px solid #000; padding-top: 10px; margin-top: 5px;">
            <span>NET TOTAL:</span> <span>â‚¹<span id="outNet">0</span></span>
        </div>
    </div>
    <div style="clear: both;"></div>
</div>

<div class="control-panel no-print">
    <h3>1. Patient & Discount</h3>
    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;">
        <input type="text" id="inName" placeholder="Name" oninput="updateView()">
        <input type="text" id="inAge" placeholder="Age/Sex" oninput="updateView()">
        <input type="text" id="inMob" placeholder="Mobile" oninput="updateView()">
        <input type="text" id="inRef" value="Self" oninput="updateView()">
        <input type="number" id="inDisc" placeholder="Discount â‚¹" oninput="updateView()">
    </div>

    <h3>2. Add Tests</h3>
    <div class="search-container">
        <input type="text" id="search" placeholder="ðŸ” Search Database..." style="width: 100%; border: 2px solid #000;" onkeyup="searchSheet()">
        <div id="dropdown"></div>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <input type="text" id="manN" placeholder="Manual Name" style="flex:2">
        <input type="number" id="manP" placeholder="Price" style="flex:1">
        <button onclick="addManual()" style="background:#007bff; color:#fff">Add Test</button>
    </div>

    <div style="margin-top: 30px; text-align: center;">
        <button onclick="printNow()" style="background:#000; color:#fff; padding: 15px 40px;">PRINT & SAVE</button>
        <button onclick="waShare()" style="background:#25d366; color:#fff; padding: 15px 40px; margin-left:10px;">WHATSAPP</button>
    </div>
</div>

<script>
    let sheetDB = [];
    let billList = [];
    let lastInv = localStorage.getItem('inv_2026') || 20260001;

    function login() {
        if(document.getElementById('pass').value === "Patel@2025") {
            document.getElementById('lock').style.display = 'none';
            setup();
        } else { alert("Incorrect Password"); }
    }

    async function setup() {
        document.getElementById('dispInv').innerText = lastInv;
        document.getElementById('dispDate').innerText = "Date: " + new Date().toLocaleDateString();
        const sid = '1_IFDJ3C5tyGHSY-pR4LSqq-mIT8Rgpx6EDDfh17zzvo';
        try {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:csv`);
            const csv = await res.text();
            sheetDB = csv.split('\n').slice(1).map(r => {
                const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return { n: c[1]?.replace(/"/g,''), p: parseInt(c[2]?.replace(/"/g,'')) || 0 };
            }).filter(x => x.n);
        } catch(e) { console.error("Sheet Error"); }
    }

    function searchSheet() {
        const q = document.getElementById('search').value.toLowerCase();
        const d = document.getElementById('dropdown');
        d.innerHTML = '';
        if(!q) { d.style.display = 'none'; return; }
        sheetDB.filter(x => x.n.toLowerCase().includes(q)).slice(0, 10).forEach(m => {
            const row = document.createElement('div');
            row.className = 'drop-item';
            row.innerHTML = `<span>${m.n}</span> <b>â‚¹${m.p}</b>`;
            row.onclick = () => { addTest(m.n, m.p); d.style.display = 'none'; document.getElementById('search').value = ''; };
            d.appendChild(row);
        });
        d.style.display = 'block';
    }

    function addManual() {
        const n = document.getElementById('manN').value;
        const p = document.getElementById('manP').value;
        if(n && p) { addTest(n, parseInt(p)); document.getElementById('manN').value = ''; document.getElementById('manP').value = ''; }
    }

    function addTest(n, p) {
        billList.push({n, p});
        updateView();
    }

    function updateView() {
        document.getElementById('outName').innerText = document.getElementById('inName').value;
        document.getElementById('outAge').innerText = document.getElementById('inAge').value;
        document.getElementById('outMob').innerText = document.getElementById('inMob').value;
        document.getElementById('outRef').innerText = document.getElementById('inRef').value;

        const tableBody = document.getElementById('outItems');
        tableBody.innerHTML = '';
        let sub = 0;
        billList.forEach((it) => {
            sub += it.p;
            tableBody.innerHTML += `<tr><td>${it.n}</td><td style="text-align:right">${it.p}</td></tr>`;
        });

        const discount = parseInt(document.getElementById('inDisc').value) || 0;
        const discRow = document.getElementById('discRow');
        
        // Logical check: If discount > 0, show the row. Otherwise, hide it.
        if (discount > 0) {
            discRow.classList.add('has-value');
            document.getElementById('outDisc').innerText = discount;
        } else {
            discRow.classList.remove('has-value');
        }

        document.getElementById('outSub').innerText = sub;
        document.getElementById('outNet').innerText = sub - discount;
    }

    function printNow() {
        if(!document.getElementById('inName').value) return alert("Enter Patient Name");
        window.print();
        localStorage.setItem('inv_2026', parseInt(lastInv) + 1);
        location.reload();
    }

    function waShare() {
        const name = document.getElementById('inName').value;
        const net = document.getElementById('outNet').innerText;
        const mob = document.getElementById('inMob').value;
        const text = `*PATEL DIAGNOSTIC UDAIPUR*%0AInvoice: ${lastInv}%0APatient: ${name}%0ATotal Amount: â‚¹${net}%0A_Reports will be ready soon._`;
        window.open(`https://wa.me/91${mob}?text=${text}`, '_blank');
    }
</script>
</body>
</html>
