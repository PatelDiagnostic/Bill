<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patel Diagnostic - Simple Print</title>
    <style>
        /* A4 Page Logic */
        @page { size: A4; margin: 0; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
        
        /* Login Screen */
        #lock { position: fixed; inset: 0; background: #333; z-index: 999; display: flex; justify-content: center; align-items: center; color: #fff; }
        .lock-box { background: #fff; padding: 20px; border-radius: 5px; color: #000; text-align: center; }

        /* Print Container (Upper A4) */
        .a4-page { width: 210mm; height: 297mm; background: #fff; margin: 0 auto; padding: 10mm; box-sizing: border-box; }
        .invoice-area { width: 100%; border-bottom: 1px dashed #000; padding-bottom: 20px; }

        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; }
        .header h1 { margin: 0; font-size: 24px; }
        
        .info-table { width: 100%; margin-bottom: 20px; font-size: 14px; }
        .info-table td { padding: 5px 0; border-bottom: 1px solid #eee; }

        .items-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .items-table th { border: 1px solid #000; padding: 8px; background: #f0f0f0; text-align: left; }
        .items-table td { border: 1px solid #000; padding: 8px; }

        .summary { float: right; width: 200px; margin-top: 15px; font-weight: bold; }
        .summary div { display: flex; justify-content: space-between; padding: 3px 0; }

        /* Interface (Hidden during print) */
        .controls { background: #eee; padding: 15px; margin-top: 20px; border-radius: 8px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input, button { padding: 8px; border: 1px solid #000; }
        #drop { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; display: none; background: #fff; }
        .item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }

        @media print {
            .controls, #lock, .del-btn { display: none !important; }
            body { background: #fff; }
            .a4-page { width: 100%; margin: 0; padding: 10mm; }
        }
    </style>
</head>
<body>

<div id="lock">
    <div class="lock-box">
        <h3>Admin Login</h3>
        <input type="password" id="pw" placeholder="Password">
        <button onclick="login()">Enter</button>
    </div>
</div>

<div class="a4-page">
    <div class="invoice-area" id="bill">
        <div class="header">
            <h1>PATEL DIAGNOSTIC UDAIPUR</h1>
            <p>Titaradi, Udaipur | Mob: 8209746239</p>
        </div>

        <table class="info-table">
            <tr>
                <td style="width:50%"><b>Invoice:</b> <span id="invNo">---</span></td>
                <td style="text-align:right"><b>Date:</b> <span id="curDate"></span></td>
            </tr>
            <tr>
                <td><b>Patient:</b> <input type="text" id="pName" placeholder="Name..." style="border:none; width:80%"></td>
                <td><b>Age/Sex:</b> <input type="text" id="pAge" placeholder="00/M" style="border:none; width:50%"></td>
            </tr>
            <tr>
                <td><b>Mobile:</b> <input type="text" id="pMob" placeholder="0000000000" style="border:none;"></td>
                <td><b>Ref By:</b> <input type="text" id="pRef" value="Self" style="border:none;"></td>
            </tr>
        </table>

        <table class="items-table">
            <thead>
                <tr>
                    <th>Test Name</th>
                    <th style="width:100px; text-align:right;">Price (₹)</th>
                    <th class="del-btn" style="width:30px"></th>
                </tr>
            </thead>
            <tbody id="list"></tbody>
        </table>

        <div class="summary">
            <div><span>Total:</span> <span id="sum">0</span></div>
            <div><span>Discount:</span> <input type="number" id="dsc" value="0" oninput="calc()" style="width:60px; text-align:right"></div>
            <div style="border-top:2px solid #000; font-size:18px; margin-top:5px;">
                <span>Net:</span> <span>₹<span id="net">0</span></span>
            </div>
        </div>
        <div style="clear:both"></div>
    </div>

    <div class="controls">
        <div style="font-weight:bold; margin-bottom:10px;">ADD TESTS:</div>
        <div class="input-row">
            <div style="flex:1">
                <input type="text" id="search" placeholder="Search Google Sheet..." onkeyup="searchDB()" style="width:100%">
                <div id="drop"></div>
            </div>
            <input type="text" id="mName" placeholder="Manual Name">
            <input type="number" id="mPrice" placeholder="Price" style="width:80px">
            <button onclick="addM()" style="background:#000; color:#fff">Add Manual</button>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button onclick="doPrint()" style="background:#2ecc71; color:#fff; flex:1; padding:15px; font-weight:bold;">PRINT & SAVE BILL</button>
            <button onclick="doWA()" style="background:#25d366; color:#fff; flex:1; font-weight:bold;">WHATSAPP MESSAGE</button>
        </div>
    </div>
</div>

<script>
    let master = [];
    let active = [];
    let inv = localStorage.getItem('patel_inv') || 20260001;

    function login() {
        if(document.getElementById('pw').value === "Patel@2025") {
            document.getElementById('lock').style.display='none';
            init();
        } else { alert("Wrong Password"); }
    }

    async function init() {
        document.getElementById('invNo').innerText = inv;
        document.getElementById('curDate').innerText = new Date().toLocaleDateString();
        const sid = '1_IFDJ3C5tyGHSY-pR4LSqq-mIT8Rgpx6EDDfh17zzvo';
        try {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${sid}/gviz/tq?tqx=out:csv`);
            const csv = await res.text();
            master = csv.split('\n').slice(1).map(r => {
                const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return { n: c[1]?.replace(/"/g,''), p: parseInt(c[2]?.replace(/"/g,'')) || 0 };
            }).filter(x => x.n);
        } catch(e) { console.log("Offline Mode"); }
    }

    function searchDB() {
        const q = document.getElementById('search').value.toLowerCase();
        const d = document.getElementById('drop');
        d.innerHTML = '';
        if(!q) { d.style.display='none'; return; }
        master.filter(x => x.n.toLowerCase().includes(q)).slice(0,8).forEach(m => {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `<span>${m.n}</span> <b>₹${m.p}</b>`;
            div.onclick = () => { add(m.n, m.p); d.style.display='none'; document.getElementById('search').value=''; };
            d.appendChild(div);
        });
        d.style.display = 'block';
    }

    function addM() {
        const n = document.getElementById('mName').value;
        const p = document.getElementById('mPrice').value;
        if(n && p) { add(n, parseInt(p)); document.getElementById('mName').value=''; document.getElementById('mPrice').value=''; }
    }

    function add(n, p) {
        active.push({n, p});
        render();
    }

    function render() {
        const l = document.getElementById('list');
        l.innerHTML = '';
        let s = 0;
        active.forEach((x, i) => {
            s += x.p;
            l.innerHTML += `<tr><td>${x.n}</td><td style="text-align:right">${x.p}</td><td class="del-btn" style="color:red; cursor:pointer" onclick="active.splice(${i},1);render()">X</td></tr>`;
        });
        document.getElementById('sum').innerText = s;
        calc();
    }

    function calc() {
        const s = parseInt(document.getElementById('sum').innerText);
        const d = parseInt(document.getElementById('dsc').value) || 0;
        document.getElementById('net').innerText = s - d;
    }

    function doPrint() {
        if(!document.getElementById('pName').value) return alert("Enter Name");
        window.print();
        localStorage.setItem('patel_inv', parseInt(inv) + 1);
        location.reload();
    }

    function doWA() {
        const name = document.getElementById('pName').value;
        const mob = document.getElementById('pMob').value;
        const net = document.getElementById('net').innerText;
        const text = `*PATEL DIAGNOSTIC UDAIPUR*%0AInv: ${inv}%0APatient: ${name}%0ATotal: ₹${net}%0A_Report will be sent soon._`;
        window.open(`https://wa.me/91${mob}?text=${text}`, '_blank');
    }
</script>
</body>
</html>
