<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PATEL DIAGNOSTIC UDAIPUR - Final Locked Invoice</title>
    <style>
        @page { size: A5; margin: 5mm; }
        body { font-family: 'Arial', sans-serif; margin: 10mm; font-size: 11px; width: 148mm; color: #000; }
        
        /* LOCKED HEADER */
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
        .header h1 { margin: 0; font-size: 18px; text-transform: uppercase; }

        /* CONTROL PANEL (NON-PRINTING) */
        .no-print { background: #f1f3f4; padding: 10px; border: 1px solid #999; margin-bottom: 10px; border-radius: 4px; }
        .input-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 5px; }
        input, select { padding: 4px; border: 1px solid #777; width: 100%; box-sizing: border-box; }
        
        .dropdown { 
            position: absolute; background: #fff; border: 1px solid #000; 
            max-height: 150px; overflow-y: auto; display: none; z-index: 1000; width: 250px;
        }
        .dropdown div { padding: 6px; cursor: pointer; border-bottom: 1px solid #eee; }
        .dropdown div:hover { background: #d1e7ff; }

        /* INVOICE LAYOUT */
        .bill-info { display: flex; justify-content: space-between; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #000; padding: 4px; text-align: left; }
        .totals { float: right; width: 45%; margin-top: 8px; }
        .t-row { display: flex; justify-content: space-between; padding: 1px 0; }
        
        @media print { 
            .no-print, .rem-btn { display: none !important; } 
            .hide-discount { display: none !important; }
            body { margin: 0; padding: 5mm; }
        }
    </style>
</head>
<body onload="loadTests()">

    <div class="header">
        <h1>PATEL DIAGNOSTIC UDAIPUR</h1>
        <p style="margin:2px 0;">Quality & Precision in Diagnostics</p>
    </div>

    <div class="no-print">
        <div class="input-row">
            <div style="position:relative;">
                <input type="text" id="pSearch" placeholder="ðŸ” Search Old Patient..." onkeyup="findPatient(this.value)">
                <div id="pResults" class="dropdown"></div>
            </div>
            <div style="position:relative;">
                <input type="text" id="tSearch" placeholder="ðŸ” Search Test Name..." onkeyup="findTest(this.value)">
                <div id="tResults" class="dropdown"></div>
            </div>
            <input type="number" id="discInp" placeholder="Discount Amount" oninput="calc()">
        </div>
        
        <div class="input-row" style="margin-top:5px;">
            <input type="text" id="pName" placeholder="Name" oninput="sync()">
            <input type="text" id="pAge" placeholder="Age" oninput="sync()">
            <select id="pSex" onchange="sync()"><option>Male</option><option>Female</option></select>
            <input type="text" id="pContact" placeholder="Contact" oninput="sync()">
            <input type="text" id="pRef" placeholder="Ref. By" oninput="sync()">
            <button onclick="saveAndPrint()" style="background:#202124; color:#fff; border:none; cursor:pointer;">PRINT & UPLOAD</button>
        </div>
    </div>

    <div class="bill-info">
        <div>
            <div><strong>Bill No:</strong> <span id="billNo">20260001</span></div>
            <div><strong>Patient:</strong> <span id="dName">---</span></div>
            <div><strong>Age/Sex:</strong> <span id="dAgeSex">---</span></div>
        </div>
        <div style="text-align: right;">
            <div><strong>Date:</strong> <span id="liveClock"></span></div>
            <div><strong>Contact:</strong> <span id="dContact">---</span></div>
            <div><strong>Ref:</strong> <span id="dRef">---</span></div>
        </div>
    </div>

    <table id="billTable">
        <thead>
            <tr><th>Test Description</th><th style="width:70px; text-align:right;">Price</th><th class="rem-btn" style="width:25px;"></th></tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="totals">
        <div class="t-row"><span>Sub-Total:</span><span id="subT">0.00</span></div>
        <div class="t-row" id="discRow"><span>Discount:</span><span id="dispD">0.00</span></div>
        <div class="t-row" style="font-weight:bold; border-top:1px solid #000; padding-top:4px;">
            <span>Grand Total:</span><span id="grandT">0.00</span>
        </div>
    </div>

    <script>
        const DEPLOY_URL = "https://script.google.com/macros/s/AKfycbzTEpSNc5B2tfFdbDHHau3HTvrjODiEOXJS2TPXtSw/exec";
        let testData = [];
        let billIdx = localStorage.getItem('pdu_bill_idx') || 20260001;

        async function loadTests() {
            document.getElementById('billNo').innerText = billIdx;
            try {
                const r = await fetch(`${DEPLOY_URL}?type=tests`);
                testData = await r.json();
            } catch(e) { console.error("Could not load price list."); }
        }

        function findTest(v) {
            let res = document.getElementById('tResults');
            res.innerHTML = "";
            if(v.length < 2) { res.style.display="none"; return; }
            let hits = testData.filter(t => t.name.toLowerCase().includes(v.toLowerCase())).slice(0, 10);
            hits.forEach(t => {
                let d = document.createElement('div');
                d.innerText = `${t.name} (â‚¹${t.price})`;
                d.onclick = () => { addRow(t.name, t.price); res.style.display="none"; document.getElementById('tSearch').value=""; };
                res.appendChild(d);
            });
            res.style.display = hits.length ? "block" : "none";
        }

        async function findPatient(v) {
            let res = document.getElementById('pResults');
            if(v.length < 4) { res.style.display="none"; return; }
            const r = await fetch(`${DEPLOY_URL}?type=patient&query=${v}`);
            const data = await r.json();
            res.innerHTML = "";
            data.forEach(p => {
                let d = document.createElement('div');
                d.innerText = `${p.name} (${p.contact})`;
                d.onclick = () => { 
                    document.getElementById('pName').value = p.name;
                    document.getElementById('pAge').value = p.age;
                    document.getElementById('pSex').value = p.sex;
                    document.getElementById('pContact').value = p.contact;
                    sync();
                    res.style.display="none";
                };
                res.appendChild(d);
            });
            res.style.display = data.length ? "block" : "none";
        }

        function addRow(n, p) {
            let b = document.getElementById('billTable').tBodies[0];
            let r = b.insertRow();
            r.innerHTML = `<td>${n}</td><td style="text-align:right;">${parseFloat(p).toFixed(2)}</td><td class="rem-btn"><button onclick="this.parentElement.parentElement.remove();calc();">Ã—</button></td>`;
            calc();
        }

        function sync() {
            document.getElementById('dName').innerText = document.getElementById('pName').value || "---";
            document.getElementById('dAgeSex').innerText = `${document.getElementById('pAge').value || '0'} / ${document.getElementById('pSex').value}`;
            document.getElementById('dContact').innerText = document.getElementById('pContact').value || "---";
            document.getElementById('dRef').innerText = document.getElementById('pRef').value || "---";
        }

        function calc() {
            let s = 0;
            let rows = document.getElementById('billTable').tBodies[0].rows;
            for(let r of rows) { s += parseFloat(r.cells[1].innerText); }
            let d = parseFloat(document.getElementById('discInp').value) || 0;
            document.getElementById('subT').innerText = s.toFixed(2);
            document.getElementById('dispD').innerText = d.toFixed(2);
            document.getElementById('grandT').innerText = (s - d).toFixed(2);
            document.getElementById('discRow').className = d <= 0 ? "t-row hide-discount" : "t-row";
        }

        setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleString(); }, 1000);

        function saveAndPrint() {
            localStorage.setItem('pdu_bill_idx', ++billIdx);
            window.print();
        }
    </script>
</body>
</html>
