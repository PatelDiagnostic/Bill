<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patel Diagnostic - Upper A4 System</title>
    <style>
        /* A4 Page Setup */
        @page { size: A4; margin: 0; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; }
        
        /* Container stays at top of A4 */
        .page-container { width: 210mm; height: 297mm; background: white; margin: 0 auto; padding: 10mm; box-sizing: border-box; }
        
        /* Invoice occupies only the top half (~148mm) */
        .invoice-box { width: 100%; min-height: 135mm; border-bottom: 1px dashed #ccc; padding-bottom: 10px; position: relative; }

        .header { text-align: center; border-bottom: 2px solid #b71c1c; margin-bottom: 10px; }
        .header h1 { margin: 0; font-size: 24px; color: #b71c1c; }
        .meta-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        .patient-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; margin-bottom: 15px; }
        .patient-grid div { display: flex; border-bottom: 1px solid #ddd; }
        .patient-grid label { font-weight: bold; width: 90px; color: #555; }
        .patient-grid input { border: none; outline: none; width: 100%; padding: 2px; font-size: 13px; background: transparent; }

        /* SEPARATE ENTRY BOXES */
        .entry-section { background: #f9f9f9; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; padding: 10px; }
        .section-tag { font-size: 10px; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 5px; display: block; }
        
        /* Search */
        .search-wrap { position: relative; }
        .search-in { width: 100%; padding: 10px; border: 2px solid #4CAF50; border-radius: 4px; box-sizing: border-box; }
        #dropdown { position: absolute; width: 100%; background: white; border: 1px solid #ccc; z-index: 100; max-height: 150px; overflow-y: auto; display: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .drop-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 13px; }
        .drop-item:hover { background: #e8f5e9; }

        /* Manual */
        .manual-flex { display: flex; gap: 8px; }
        .m-name { flex: 2; padding: 10px; border: 2px solid #007bff; border-radius: 4px; }
        .m-price { width: 90px; padding: 10px; border: 2px solid #007bff; border-radius: 4px; }
        .add-btn { background: #007bff; color: white; border: none; padding: 0 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* Table */
        .invoice-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        .invoice-table th { background: #4CAF50; color: white; padding: 10px; text-align: left; }
        .invoice-table td { padding: 10px; border-bottom: 1px solid #ddd; }
        
        .totals { margin-top: 10px; float: right; width: 250px; }
        .total-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .disc-box { width: 80px; text-align: right; border: 1px solid #ccc; padding: 5px; font-weight: bold; }

        .no-print { display: flex; justify-content: center; gap: 15px; margin-top: 20px; padding: 20px; background: #eee; border-radius: 8px; }
        .btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; font-size: 14px; }
        .save-btn { background: #2e7d32; }
        .wa-btn { background: #25d366; }

        .history-panel { margin-top: 20px; border: 1px solid #007bff; padding: 10px; background: #eef7ff; border-radius: 6px; }

        @media print {
            .no-print, .entry-section, .history-panel, .del-col { display: none !important; }
            body { background: white; }
            .page-container { margin: 0; padding: 10mm; width: 210mm; }
            .invoice-box { border-bottom: none; }
            .disc-box { border: none !important; }
        }
    </style>
</head>
<body onload="startup()">

<div class="page-container">
    <div class="invoice-box" id="printArea">
        <div class="header">
            <h1>PATEL DIAGNOSTIC UDAIPUR</h1>
            <p>Titaradi, Udaipur | 8209746239</p>
        </div>

        <div class="meta-row">
            <div>Invoice No: <b id="displayInv">20260001</b></div>
            <div id="dateTime"></div>
        </div>

        <div class="patient-grid">
            <div><label>Name:</label><input type="text" id="pName"></div>
            <div><label>Age/Sex:</label><input type="text" id="pAge"></div>
            <div><label>Mobile:</label><input type="text" id="pMob"></div>
            <div><label>Ref. By:</label><input type="text" id="pRef" value="Self"></div>
        </div>

        <div class="entry-section no-print" style="border-color: #4CAF50;">
            <span class="section-tag">üîç Search Google Sheet Database</span>
            <div class="search-wrap">
                <input type="text" id="sheetSearch" class="search-in" placeholder="Type Test Name..." onkeyup="liveSearch()">
                <div id="dropdown"></div>
            </div>
            <div id="loadMsg" style="font-size: 10px; color: green; margin-top: 5px;">Connecting...</div>
        </div>

        <div class="entry-section no-print" style="border-color: #007bff;">
            <span class="section-tag">‚úçÔ∏è Manual Price Entry</span>
            <div class="manual-flex">
                <input type="text" id="manualN" class="m-name" placeholder="Test Name">
                <input type="number" id="manualP" class="m-price" placeholder="Price">
                <button class="add-btn" onclick="addManual()">ADD TEST</button>
            </div>
        </div>

        <table class="invoice-table">
            <thead>
                <tr>
                    <th style="width: 70%;">Test Description</th>
                    <th style="text-align: right; width: 20%;">Price (‚Çπ)</th>
                    <th class="del-col no-print" style="width: 10%;"></th>
                </tr>
            </thead>
            <tbody id="billBody"></tbody>
        </table>

        <div class="totals">
            <div class="total-row">Sub Total: <span>‚Çπ<span id="subT">0</span></span></div>
            <div class="total-row">Discount: <input type="number" id="discIn" class="disc-box" value="0" oninput="calculate()"></div>
            <div class="total-row" style="color: #b71c1c; border-top: 1px solid #eee; padding-top: 5px;">Net Payable: <span>‚Çπ<span id="netT">0</span></span></div>
        </div>
        <div style="clear: both;"></div>
    </div>

    <div class="no-print">
        <button class="btn save-btn" onclick="saveAndPrint()">PRINT & SAVE</button>
        <button class="btn wa-btn" onclick="sendWA()">WHATSAPP PDF</button>
    </div>

    <div class="history-panel no-print">
        <span class="section-tag" style="color: #007bff;">üìú Search Saved History</span>
        <input type="text" id="histSearch" style="width: 100%; padding: 8px; border: 1px solid #007bff;" placeholder="Name or Mobile..." onkeyup="findHist()">
        <div id="histOutput" style="max-height: 100px; overflow-y: auto; background: white; margin-top: 5px; font-size: 12px;"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    let db = [];
    let items = [];
    let currentInv = localStorage.getItem('p_inv_2026') || 20260001;
    let records = JSON.parse(localStorage.getItem('p_records')) || [];

    async function startup() {
        document.getElementById('displayInv').innerText = currentInv;
        const sheetId = '1_IFDJ3C5tyGHSY-pR4LSqq-mIT8Rgpx6EDDfh17zzvo';
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

        try {
            const res = await fetch(url);
            const csv = await res.text();
            const rows = csv.split('\n').slice(1);
            db = rows.map(r => {
                const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                return { n: c[1]?.replace(/"/g,'').trim(), p: parseInt(c[2]?.replace(/"/g,'')) || 0 };
            }).filter(x => x.n);
            document.getElementById('loadMsg').innerText = `‚úÖ Database Connected (${db.length} tests)`;
        } catch(e) { document.getElementById('loadMsg').innerText = "‚ùå Database Error"; }
        
        setInterval(() => { document.getElementById('dateTime').innerText = new Date().toLocaleString(); }, 1000);
    }

    function liveSearch() {
        const q = document.getElementById('sheetSearch').value.toLowerCase();
        const d = document.getElementById('dropdown');
        d.innerHTML = '';
        if(!q) { d.style.display = 'none'; return; }
        db.filter(x => x.n.toLowerCase().includes(q)).slice(0, 10).forEach(m => {
            const div = document.createElement('div');
            div.className = 'drop-item';
            div.innerHTML = `<span>${m.n}</span> <b>‚Çπ${m.p}</b>`;
            div.onclick = () => { pushItem(m.n, m.p); d.style.display='none'; document.getElementById('sheetSearch').value=''; };
            d.appendChild(div);
        });
        d.style.display = 'block';
    }

    function addManual() {
        const n = document.getElementById('manualN').value;
        const p = document.getElementById('manualP').value;
        if(n && p) { pushItem(n, parseInt(p)); document.getElementById('manualN').value=''; document.getElementById('manualP').value=''; }
    }

    function pushItem(n, p) {
        items.push({n, p});
        updateTable();
    }

    function updateTable() {
        const body = document.getElementById('billBody');
        body.innerHTML = '';
        let s = 0;
        items.forEach((it, i) => {
            s += it.p;
            body.innerHTML += `<tr><td>${it.n}</td><td style="text-align:right">${it.p}</td><td class="del-col no-print" onclick="items.splice(${i},1);updateTable()" style="color:red; cursor:pointer; text-align:center;">‚úñ</td></tr>`;
        });
        document.getElementById('subT').innerText = s;
        calculate();
    }

    function calculate() {
        const s = parseInt(document.getElementById('subT').innerText);
        const d = parseInt(document.getElementById('discIn').value) || 0;
        document.getElementById('netT').innerText = s - d;
    }

    function saveAndPrint() {
        const name = document.getElementById('pName').value;
        if(!name) return alert("Patient Name Required");
        
        records.push({
            id: currentInv, name: name, mob: document.getElementById('pMob').value,
            date: new Date().toLocaleDateString(), total: document.getElementById('netT').innerText
        });
        localStorage.setItem('p_records', JSON.stringify(records));
        
        window.print();
        localStorage.setItem('p_inv_2026', parseInt(currentInv) + 1);
        location.reload();
    }

    function sendWA() {
        const name = document.getElementById('pName').value;
        const mob = document.getElementById('pMob').value;
        const total = document.getElementById('netT').innerText;
        
        html2pdf().from(document.getElementById('printArea')).set({ 
            margin: 10, filename: `Bill_${name}.pdf`, jsPDF: { format: 'a5' } 
        }).save();

        const text = `*PATEL DIAGNOSTIC UDAIPUR*%0AInv No: ${currentInv}%0APatient: ${name}%0ATotal: ‚Çπ${total}%0A_PDF Invoice Attached below._`;
        window.open(`https://wa.me/91${mob}?text=${text}`, '_blank');
    }

    function findHist() {
        const q = document.getElementById('histSearch').value.toLowerCase();
        const out = document.getElementById('histOutput');
        out.innerHTML = '';
        if(!q) return;
        records.filter(r => r.name.toLowerCase().includes(q) || r.mob.includes(q)).reverse().forEach(r => {
            out.innerHTML += `<div style="padding:5px; border-bottom:1px solid #ddd;">#${r.id} | ${r.name} | ‚Çπ${r.total}</div>`;
        });
    }
</script>
</body>
</html>
