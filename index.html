<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDU Billing System</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #e67e22; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #333; }
        
        .invoice-container { 
            width: 210mm; height: 148.5mm; background: #fff; margin: 0 auto; 
            padding: 30px; box-sizing: border-box; position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #ddd;
        }

        .header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--primary-color); padding-bottom: 10px; }
        .lab-brand h1 { margin: 0; font-size: 26px; color: var(--primary-color); font-weight: 800; }
        .lab-brand p { margin: 2px 0; font-size: 12px; line-height: 1.4; }
        
        .barcode-box { text-align: right; }
        #barcode { width: 140px; height: 45px; margin-top: 5px; }
        .inv-text { font-size: 15px; font-weight: bold; color: var(--accent-color); }

        .patient-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .field { display: flex; border-bottom: 1px solid #eee; padding: 5px 0; }
        .field label { font-weight: 600; width: 110px; font-size: 13px; color: #555; }
        .field input, .field select { border: none; outline: none; font-size: 13px; flex: 1; background: transparent; color: #000; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 10px; background: #f8f9fa; font-size: 12px; border-bottom: 2px solid #333; text-transform: uppercase; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f1f1; position: relative; }
        
        /* Manual Entry Styling */
        .test-input-group { display: flex; gap: 5px; width: 100%; }
        .test-select { flex: 1; border: 1px solid #eee; padding: 5px; border-radius: 4px; font-size: 13px; }
        .manual-test-input { flex: 1; border: 1px solid var(--accent-color); padding: 5px; border-radius: 4px; font-size: 13px; display: none; }
        
        .price-display { border: none; background: transparent; width: 100%; font-weight: bold; font-size: 14px; text-align: right; }

        .summary-wrapper { display: flex; justify-content: flex-end; margin-top: 15px; }
        .summary-table { width: 250px; }
        .sum-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; }
        .grand-total { border-top: 2px solid var(--primary-color); margin-top: 5px; padding-top: 8px; font-weight: bold; font-size: 18px; color: #000; }

        .no-print-zone { width: 210mm; margin: 0 auto 15px; display: flex; gap: 10px; justify-content: center; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .btn-main { background: #2c3e50; }
        .btn-wa { background: #25d366; }
        .btn-search { background: #f39c12; }
        .btn-remove { background: #e74c3c; border:none; color:white; padding: 2px 6px; border-radius: 3px; position: absolute; right: -35px; cursor: pointer; }
        
        .search-panel { width: 210mm; margin: 0 auto 15px; background: white; padding: 20px; border-radius: 8px; display: none; border: 1px solid #ddd; }
        
        @media print {
            .no-print-zone, .btn-remove, .search-panel, .row-empty, button { display: none !important; }
            body { background: white; padding: 0; }
            .invoice-container { border: none; box-shadow: none; margin: 0; width: 100%; height: auto; }
            .field input, .field select, .test-select, .manual-test-input { border: none !important; appearance: none; pointer-events: none; color: #000 !important; }
            .field { border-bottom: 1px dashed #ccc; }
        }
    </style>
</head>
<body>

<div class="no-print-zone">
    <button class="btn btn-search" onclick="toggleSearch()">üîç Search History</button>
    <button class="btn btn-main" onclick="processInvoice()">üíæ Save & Sync Cloud</button>
    <button class="btn btn-wa" onclick="shareWhatsApp()">üì± WhatsApp</button>
    <button class="btn" style="background:#95a5a6" onclick="location.reload()">üîÑ New Bill</button>
</div>

<div id="searchPanel" class="search-panel">
    <input type="text" id="searchQuery" placeholder="Find Name, Mobile or ID..." style="padding:10px; width:350px;">
    <button class="btn btn-search" onclick="runSearch()" style="padding:10px;">Search</button>
    <div id="searchRes" style="margin-top:20px; max-height: 300px; overflow-y: auto;"></div>
</div>

<div class="invoice-container">
    <div class="header">
        <div class="lab-brand">
            <h1>DIAGNOSTIC CARE LAB</h1>
            <p>ISO Certified Laboratory<br>Pathology | Biochemistry | Hematology<br>Main Road Plaza | Ph: 9876543210</p>
        </div>
        <div class="barcode-box">
            <div class="inv-text">ID: <span id="inv-id"></span></div>
            <svg id="barcode"></svg>
            <div id="curr-time" style="font-size: 11px; font-weight: bold; margin-top: 3px; color: #666;"></div>
        </div>
    </div>

    <form id="billingForm">
        <div class="patient-grid">
            <div class="field"><label>Patient Name*:</label><input type="text" id="name" oninput="updateFileName()" required></div>
            <div class="field">
                <label>Age/Sex*:</label>
                <input type="text" id="age" style="width: 45px;" placeholder="Age" required>
                <select id="sex" style="width: 55px;"><option>M</option><option>F</option></select>
            </div>
            <div class="field"><label>Mobile No*:</label><input type="tel" id="mobile" pattern="[0-9]{10}" required></div>
            <div class="field"><label>Ref. By:</label><input type="text" id="ref" placeholder="Self"></div>
        </div>

        <table>
            <thead><tr><th width="75%">Investigation</th><th width="25%" style="text-align:right;">Price (‚Çπ)</th></tr></thead>
            <tbody id="testRows">
                <tr class="row-empty">
                    <td>
                        <div class="test-input-group">
                            <select class="test-select" onchange="handleTestChange(this)">
                                <option value="" data-p="0">-- Select Test --</option>
                                <option value="CBC" data-p="500">CBC (Complete Blood Count)</option>
                                <option value="LFT" data-p="850">LFT (Liver Function)</option>
                                <option value="KFT" data-p="900">KFT (Kidney Function)</option>
                                <option value="Sugar" data-p="150">Blood Sugar</option>
                                <option value="MANUAL" style="color:var(--accent-color); font-weight:bold;">+ Add Manual Test</option>
                            </select>
                            <input type="text" class="manual-test-input" placeholder="Type Test Name..." oninput="recalc()">
                        </div>
                    </td>
                    <td>
                        <input type="number" class="price-display" value="0" oninput="recalc()">
                        <button type="button" class="btn-remove no-print" onclick="removeRow(this)">‚úñ</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <button type="button" class="no-print" onclick="addRow()" style="margin-top:12px;">+ Add Next Row</button>

        <div class="summary-wrapper">
            <div class="summary-table">
                <div class="sum-row"><span>Sub-Total:</span> <span>‚Çπ<span id="subTotal">0.00</span></span></div>
                <div class="sum-row"><span>Discount:</span> <input type="number" id="disc" value="0" oninput="recalc()" style="width:70px; text-align:right;"></div>
                <div class="sum-row"><span>Paid:</span> <input type="number" id="paid" value="0" oninput="recalc()" style="width:70px; text-align:right;"></div>
                <div class="sum-row grand-total"><span>Due:</span> <span>‚Çπ<span id="dueTotal">0.00</span></span></div>
            </div>
        </div>
    </form>
</div>

<script>
    const START_SERIAL = 20262001;
    const G_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzqHZoI5kCUi7hUFZPvrjbhhKTf6HcgV6Yo9QMgKXVn/exec"; 
    
    let currentActiveID = "";
    let clockInterval;

    function handleTestChange(sel) {
        const row = sel.closest('tr');
        const manualInput = row.querySelector('.manual-test-input');
        const priceInput = row.querySelector('.price-display');

        if (sel.value === "MANUAL") {
            sel.style.display = "none";
            manualInput.style.display = "block";
            manualInput.focus();
            priceInput.readOnly = false; // Allow manual price for manual tests
            priceInput.value = "";
            row.classList.remove('row-empty');
        } else if (sel.value !== "") {
            priceInput.value = sel.options[sel.selectedIndex].getAttribute('data-p');
            priceInput.readOnly = true;
            row.classList.remove('row-empty');
        } else {
            row.classList.add('row-empty');
            priceInput.value = 0;
        }
        recalc();
    }

    function updateFileName() {
        const pName = document.getElementById('name').value || "Guest";
        document.title = pName + " - " + (currentActiveID || "Bill");
    }

    function generateInvoiceID(manualID = null) {
        if(manualID) {
            currentActiveID = manualID;
        } else {
            let last = localStorage.getItem('last_pdu_serial');
            last = last ? parseInt(last) + 1 : START_SERIAL;
            currentActiveID = "PDU" + last;
        }
        document.getElementById('inv-id').innerText = currentActiveID;
        JsBarcode("#barcode", currentActiveID, { format: "CODE128", width: 1.8, height: 40, displayValue: false, margin: 0 });
        updateFileName();
    }

    function updateClock(manualTime = null) {
        if(manualTime) {
            document.getElementById('curr-time').innerText = manualTime;
        } else {
            const now = new Date();
            document.getElementById('curr-time').innerText = now.toLocaleDateString('en-GB') + ' | ' + now.toLocaleTimeString('en-GB');
        }
    }

    function startLiveClock() {
        updateClock();
        clockInterval = setInterval(updateClock, 1000);
    }

    generateInvoiceID();
    startLiveClock();

    function addRow() {
        const row = document.querySelector('#testRows tr').cloneNode(true);
        row.classList.add('row-empty');
        row.querySelector('.price-display').value = 0;
        row.querySelector('.price-display').readOnly = true;
        const sel = row.querySelector('.test-select');
        sel.selectedIndex = 0;
        sel.style.display = "block";
        row.querySelector('.manual-test-input').style.display = "none";
        row.querySelector('.manual-test-input').value = "";
        document.getElementById('testRows').appendChild(row);
        return row;
    }

    function removeRow(btn) {
        if(document.querySelectorAll('#testRows tr').length > 1) { btn.closest('tr').remove(); recalc(); }
    }

    function recalc() {
        let sub = 0;
        document.querySelectorAll('.price-display').forEach(i => sub += parseFloat(i.value || 0));
        const d = parseFloat(document.getElementById('disc').value || 0);
        const p = parseFloat(document.getElementById('paid').value || 0);
        document.getElementById('subTotal').innerText = sub.toFixed(2);
        document.getElementById('dueTotal').innerText = (sub - d - p).toFixed(2);
    }

    async function processInvoice() {
        const form = document.getElementById('billingForm');
        if(!form.checkValidity()) { form.reportValidity(); return; }

        const tests = [];
        document.querySelectorAll('#testRows tr:not(.row-empty)').forEach(r => {
            const sel = r.querySelector('.test-select');
            const manual = r.querySelector('.manual-test-input');
            const testName = (sel.value === "MANUAL") ? manual.value : sel.value;
            if(testName) {
                tests.push({v: testName, p: r.querySelector('.price-display').value});
            }
        });

        const record = {
            id: currentActiveID,
            name: document.getElementById('name').value,
            age: document.getElementById('age').value,
            sex: document.getElementById('sex').value,
            mob: document.getElementById('mobile').value,
            ref: document.getElementById('ref').value,
            tests: tests,
            subTotal: document.getElementById('subTotal').innerText,
            disc: document.getElementById('disc').value,
            paid: document.getElementById('paid').value,
            due: document.getElementById('dueTotal').innerText,
            date: document.getElementById('curr-time').innerText
        };

        // 1. Local Storage
        let db = JSON.parse(localStorage.getItem('pdu_final_sync_db') || '[]');
        db.push(record);
        localStorage.setItem('pdu_final_sync_db', JSON.stringify(db));
        localStorage.setItem('last_pdu_serial', currentActiveID.replace("PDU", ""));

        // 2. Cloud Sync
        try {
            await fetch(G_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(record)
            });
        } catch (err) { console.log("Sync Error"); }

        window.print();
        setTimeout(() => { location.reload(); }, 1000);
    }

    function runSearch() {
        const q = document.getElementById('searchQuery').value.toLowerCase();
        const db = JSON.parse(localStorage.getItem('pdu_final_sync_db') || '[]');
        const res = db.filter(r => r.name.toLowerCase().includes(q) || r.mob.includes(q) || r.id.toLowerCase().includes(q));
        let h = '<table style="width:100%; font-size:12px;"><tr><th>ID</th><th>Patient</th><th>Action</th></tr>';
        res.reverse().forEach(r => {
            h += `<tr><td>${r.id}</td><td>${r.name}</td><td><button onclick='reprint("${r.id}")'>Reprint</button></td></tr>`;
        });
        document.getElementById('searchRes').innerHTML = res.length ? h + '</table>' : 'No records.';
    }

    function reprint(id) {
        const db = JSON.parse(localStorage.getItem('pdu_final_sync_db') || '[]');
        const d = db.find(r => r.id === id); if(!d) return;
        clearInterval(clockInterval);
        generateInvoiceID(d.id);
        updateClock(d.date);
        document.getElementById('name').value = d.name;
        document.getElementById('age').value = d.age;
        document.getElementById('sex').value = d.sex;
        document.getElementById('mobile').value = d.mob;
        document.getElementById('ref').value = d.ref;
        const tbody = document.getElementById('testRows');
        tbody.innerHTML = "";
        d.tests.forEach(t => {
            const r = addRow(); r.classList.remove('row-empty');
            const sel = r.querySelector('.test-select');
            const man = r.querySelector('.manual-test-input');
            const pri = r.querySelector('.price-display');
            
            // Logic to check if it was a manual test
            let exists = false;
            for(let i=0; i<sel.options.length; i++){
                if(sel.options[i].value === t.v) { exists = true; break; }
            }
            if(exists) {
                sel.value = t.v;
            } else {
                sel.style.display = "none";
                man.style.display = "block";
                man.value = t.v;
                pri.readOnly = false;
            }
            pri.value = t.p;
        });
        document.getElementById('disc').value = d.disc;
        document.getElementById('paid').value = d.paid;
        recalc();
        toggleSearch();
    }

    function toggleSearch() {
        const p = document.getElementById('searchPanel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }

    function shareWhatsApp() {
        const msg = `Patient: ${document.getElementById('name').value}\nID: ${currentActiveID}\nDue: ‚Çπ${document.getElementById('dueTotal').innerText}`;
        window.open(`https://wa.me/91${document.getElementById('mobile').value}?text=${encodeURIComponent(msg)}`, '_blank');
    }
</script>
</body>
</html>
