<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PATEL DIAGNOSTIC UDAIPUR - Invoice</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .info-section { display: flex; justify-content: space-between; margin-top: 20px; }
        .patient-details { width: 60%; }
        .bill-details { width: 35%; text-align: right; }
        .search-container { margin: 20px 0; background: #f4f4f4; padding: 15px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .totals { margin-top: 20px; text-align: right; }
        .print-btn { margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        @media print { .search-container, .print-btn { display: none; } }
    </style>
</head>
<body>

    <div class="header">
        <h1>PATEL DIAGNOSTIC UDAIPUR</h1>
        <p>Lab Invoice & Receipt</p>
    </div>

    <div class="search-container">
        <h3>Search Old Patient Data</h3>
        <input type="text" id="patientSearch" placeholder="Enter Contact or Name...">
        <button onclick="searchPatient()">Search</button>
    </div>

    <div class="info-section">
        <div class="patient-details">
            <p><strong>Name:</strong> <input type="text" id="pName"></p>
            <p><strong>Age:</strong> <input type="number" id="pAge"> <strong>Sex:</strong> 
                <select id="pSex">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </p>
            <p><strong>Contact:</strong> <input type="text" id="pContact"></p>
            <p><strong>Ref. By:</strong> <input type="text" id="pRef"></p>
        </div>
        <div class="bill-details">
            <p><strong>Bill No:</strong> <span id="billNo"></span></p>
            <p><strong>Date/Time:</strong> <span id="liveClock"></span></p>
        </div>
    </div>

    <div class="search-container">
        <h3>Add Tests</h3>
        <input type="text" id="testSearch" placeholder="Search Test Name..." onkeyup="filterTests()">
        <select id="testDropdown" style="width: 100%; margin-top: 5px;"></select>
        <button onclick="addTest()" style="margin-top: 10px;">Add to Bill</button>
    </div>

    <table id="invoiceTable">
        <thead>
            <tr>
                <th>Test Name</th>
                <th>Price</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="totals">
        <p>Sub Total: <span id="subTotal">0.00</span></p>
        <p>Discount: <input type="number" id="discount" value="0" oninput="calculateTotal()"> </p>
        <h3>Grand Total: <span id="grandTotal">0.00</span></h3>
    </div>

    <button class="print-btn" onclick="saveAndPrint()">Print to PDF & Upload Data</button>

    <script>
        const DEPLOYMENT_ID = "AKfycbzTEpSNc5B2tfFdbDHHau3HTvrjODiEOXJS2TPXtSw";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1_IFDJ3C5tyGHSY-pR4LSqq-mIT8Rgpx6EDDfh17zzvo/edit";
        
        // Initialize Bill Number
        let currentBill = localStorage.getItem('lastBill') || 20260001;
        document.getElementById('billNo').innerText = currentBill;

        // Live Clock
        setInterval(() => {
            document.getElementById('liveClock').innerText = new Date().toLocaleString();
        }, 1000);

        [span_2](start_span)// Fetch Tests from your Google Sheet data[span_2](end_span)
        const testData = [
            {name: "Complete Blood Count (CBC)", price: 249},
            {name: "Liver Function Test (LFT)", price: 399},
            {name: "Kidney Function Test (KFT)", price: 399},
            {name: "Thyroid Profile Total", price: 450},
            {name: "Vitamin D Test", price: 649},
            {name: "HbA1c Test", price: 299}
            // Add more common tests from your list here for offline speed, 
            // or fetch dynamically via the Deployment ID
        ];

        function filterTests() {
            let input = document.getElementById('testSearch').value.toUpperCase();
            let dropdown = document.getElementById('testDropdown');
            dropdown.innerHTML = "";
            testData.filter(t => t.name.toUpperCase().includes(input)).forEach(t => {
                let opt = document.createElement('option');
                opt.value = t.price;
                opt.text = `${t.name} - â‚¹${t.price}`;
                opt.dataset.name = t.name;
                dropdown.add(opt);
            });
        }

        function addTest() {
            let dropdown = document.getElementById('testDropdown');
            if(!dropdown.value) return;
            let table = document.getElementById('invoiceTable').getElementsByTagName('tbody')[0];
            let row = table.insertRow();
            row.insertCell(0).innerText = dropdown.options[dropdown.selectedIndex].dataset.name;
            row.insertCell(1).innerText = dropdown.value;
            row.insertCell(2).innerHTML = '<button onclick="this.parentElement.parentElement.remove(); calculateTotal();">Remove</button>';
            calculateTotal();
        }

        function calculateTotal() {
            let rows = document.getElementById('invoiceTable').getElementsByTagName('tbody')[0].rows;
            let sub = 0;
            for(let row of rows) sub += parseFloat(row.cells[1].innerText);
            let disc = parseFloat(document.getElementById('discount').value) || 0;
            document.getElementById('subTotal').innerText = sub.toFixed(2);
            document.getElementById('grandTotal').innerText = (sub - disc).toFixed(2);
        }

        function searchPatient() {
            // This would call your Google Apps Script 'doGet' with the search query
            alert("Connecting to Deployment ID for Patient Search...");
        }

        function saveAndPrint() {
            // Logic to send data to Google Sheet via Deployment ID
            const data = {
                billNo: currentBill,
                name: document.getElementById('pName').value,
                contact: document.getElementById('pContact').value,
                total: document.getElementById('grandTotal').innerText
            };

            // Increment Bill No for next time
            currentBill++;
            localStorage.setItem('lastBill', currentBill);
            
            window.print();
        }
    </script>
</body>
</html>
